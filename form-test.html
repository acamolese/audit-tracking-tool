<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Monitor - AuditTrackingTool</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1c3738;
      --primary-light: #2a4a4b;
      --accent: #06e89f;
      --accent-hover: #05c989;
      --bg: #f3f1ee;
      --surface: #ffffff;
      --surface-2: #f9f8f6;
      --surface-3: #eae8e4;
      --border: #e0ddd8;
      --text: #111d0c;
      --text-secondary: #5a6a5c;
      --text-muted: #8a9a8c;
      --success: #06e89f;
      --warning: #ffb84d;
      --danger: #ff4f50;
      --facebook: #1877f2;
      --google: #ea4335;
      --gtm: #4285f4;
      --clarity: #7c3aed;
      --linkedin: #0a66c2;
      --tiktok: #000000;
      --cookiebot: #00a0d6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--primary);
      border-bottom: none;
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .logo {
      font-family: 'DM Serif Display', serif;
      font-size: 20px;
      font-weight: 400;
      color: #ffffff;
      text-decoration: none;
    }

    .logo span { color: var(--accent); }

    .back-link {
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: color 0.2s;
    }

    .back-link:hover { color: #ffffff; }

    .session-status {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(255,255,255,0.1);
      color: #ffffff;
    }

    .status-badge.connected {
      background: rgba(6, 232, 159, 0.2);
      color: var(--accent);
    }

    .status-badge.connecting {
      background: rgba(255, 184, 77, 0.2);
      color: var(--warning);
    }

    .status-badge.disconnected {
      background: rgba(255, 79, 80, 0.2);
      color: var(--danger);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .header-url {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255,255,255,0.1);
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
    }

    .url-icon { font-size: 16px; }

    .url-text {
      flex: 1;
      font-size: 14px;
      color: #ffffff;
      font-weight: 500;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-ghost {
      background: rgba(255,255,255,0.1);
      color: #ffffff;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .btn-ghost:hover {
      background: rgba(255,255,255,0.2);
      color: #ffffff;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #e04546;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--primary);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    /* Main Content */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 4px 24px rgba(28, 55, 56, 0.08);
    }

    .stat-header {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-card.highlight .stat-value {
      color: var(--accent);
    }

    /* Tracker Summary */
    .tracker-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 24px;
    }

    .tracker-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      background: var(--surface);
      border: 2px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text);
    }

    .tracker-chip:hover {
      border-color: var(--primary-light);
      transform: translateY(-1px);
    }

    .tracker-chip.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--primary);
    }

    .tracker-chip .count {
      background: var(--surface-3);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }

    .tracker-chip.active .count {
      background: rgba(28,55,56,0.2);
    }

    /* Event Feed */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .live-indicator {
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    .event-feed {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .event-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      display: grid;
      grid-template-columns: auto auto 1fr auto;
      gap: 16px;
      align-items: center;
      transition: all 0.2s ease;
      animation: slideIn 0.2s ease-out;
      box-shadow: 0 2px 8px rgba(28, 55, 56, 0.04);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .event-card:hover {
      border-color: var(--primary-light);
      background: var(--surface-2);
    }

    .event-card.new {
      border-left: 4px solid var(--accent);
    }

    .tracker-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
    }

    .tracker-icon.facebook { background: rgba(24, 119, 242, 0.15); color: var(--facebook); }
    .tracker-icon.ga4 { background: rgba(234, 67, 53, 0.15); color: var(--google); }
    .tracker-icon.gtm { background: rgba(66, 133, 244, 0.15); color: var(--gtm); }
    .tracker-icon.clarity { background: rgba(124, 58, 237, 0.15); color: var(--clarity); }
    .tracker-icon.cookiebot { background: rgba(0, 160, 214, 0.15); color: var(--cookiebot); }
    .tracker-icon.linkedin { background: rgba(10, 102, 194, 0.15); color: var(--linkedin); }
    .tracker-icon.datalayer { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
    .tracker-icon.default { background: var(--surface-2); color: var(--text-secondary); }

    .event-content {
      min-width: 0;
    }

    .event-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .event-tracker {
      font-size: 13px;
      font-weight: 600;
      color: var(--primary);
    }

    .event-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--primary);
      background: rgba(6, 232, 159, 0.2);
      padding: 2px 8px;
      border-radius: 4px;
    }

    .event-category {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .event-url {
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .event-time {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
      background: var(--surface);
      border-radius: 16px;
      border: 2px dashed var(--border);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .empty-text {
      font-size: 14px;
      max-width: 400px;
      margin: 0 auto;
      line-height: 1.5;
    }

    /* Alert Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 10px 40px rgba(28, 55, 56, 0.15);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success { border-left: 4px solid var(--success); }
    .toast.warning { border-left: 4px solid var(--warning); }
    .toast.danger { border-left: 4px solid var(--danger); }

    .toast-icon { font-size: 20px; }
    .toast-content { flex: 1; }
    .toast-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; color: var(--primary); }
    .toast-text { font-size: 12px; color: var(--text-secondary); }

    /* Loading State */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 24px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--primary);
    }

    .loading-subtext {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Instruction Banner */
    .instruction-banner {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      background: linear-gradient(135deg, rgba(6, 232, 159, 0.1) 0%, rgba(28, 55, 56, 0.05) 100%);
      border: 2px solid var(--accent);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .instruction-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .instruction-content {
      flex: 1;
    }

    .instruction-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 6px;
    }

    .instruction-text {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .instruction-text strong {
      color: var(--primary);
    }

    .instruction-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition: color 0.2s;
    }

    .instruction-close:hover {
      color: var(--primary);
    }

    .instruction-banner.hidden {
      display: none;
    }

    /* Event Selection */
    .event-card {
      cursor: pointer;
      user-select: none;
    }

    .event-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      flex-shrink: 0;
      background: var(--surface);
    }

    .event-checkbox::after {
      content: '‚úì';
      color: transparent;
      font-size: 12px;
      font-weight: 700;
    }

    .event-card.selected .event-checkbox {
      background: var(--accent);
      border-color: var(--accent);
    }

    .event-card.selected .event-checkbox::after {
      color: var(--primary);
    }

    .event-card.selected {
      border-color: var(--accent);
      background: rgba(6, 232, 159, 0.05);
    }

    .event-card:hover .event-checkbox {
      border-color: var(--primary-light);
    }

    /* Selection Action Bar */
    .selection-bar {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--primary);
      border-radius: 16px;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: 0 10px 40px rgba(28, 55, 56, 0.3);
      z-index: 150;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .selection-bar.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .selection-info {
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .selection-count {
      background: var(--accent);
      color: var(--primary);
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 700;
    }

    .selection-actions {
      display: flex;
      gap: 8px;
    }

    .selection-bar .btn {
      padding: 10px 16px;
    }

    .btn-success {
      background: var(--accent);
      color: var(--primary);
    }

    .btn-success:hover {
      background: var(--accent-hover);
    }

    /* Select All Header */
    .select-all-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .select-all-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .select-all-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s ease;
      background: var(--surface);
    }

    .select-all-checkbox::after {
      content: '‚úì';
      color: transparent;
      font-size: 12px;
      font-weight: 700;
    }

    .select-all-checkbox.checked {
      background: var(--accent);
      border-color: var(--accent);
    }

    .select-all-checkbox.checked::after {
      color: var(--primary);
    }

    .select-all-checkbox.partial {
      background: var(--surface-3);
      border-color: var(--primary-light);
    }

    .select-all-checkbox.partial::after {
      content: '‚àí';
      color: var(--primary);
    }

    .select-all-label {
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header { padding: 12px 16px; }
      .main { padding: 16px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .stat-value { font-size: 24px; }
      .event-card { grid-template-columns: auto auto 1fr; }
      .event-time { display: none; }
      .selection-bar {
        left: 16px;
        right: 16px;
        transform: translateX(0) translateY(100px);
        padding: 12px 16px;
        flex-direction: column;
        gap: 12px;
      }
      .selection-bar.show {
        transform: translateX(0) translateY(0);
      }
      .selection-actions {
        width: 100%;
        justify-content: stretch;
      }
      .selection-actions .btn {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Avvio Browser</div>
    <div class="loading-subtext">Il sito si aprir√† in una finestra separata...</div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-top">
      <div style="display: flex; align-items: center; gap: 16px;">
        <a href="/" class="logo"><span>Audit</span>TrackingTool</a>
        <span style="color: rgba(255,255,255,0.5); font-size: 14px;">/ Live Monitor</span>
      </div>
      <div class="session-status">
        <div class="status-badge connecting" id="statusBadge">
          <span class="status-dot"></span>
          <span id="statusText">Connessione...</span>
        </div>
      </div>
    </div>
    <div class="header-url">
      <span class="url-icon">üåê</span>
      <span class="url-text" id="urlDisplay">Caricamento...</span>
      <div class="header-actions">
        <button class="btn btn-ghost" onclick="clearEvents()">
          üóëÔ∏è Pulisci
        </button>
        <button class="btn btn-danger" onclick="stopSession()">
          ‚èπÔ∏è Chiudi
        </button>
        <a class="btn btn-primary" id="viewReportBtn" href="#" style="display: none; text-decoration: none;">
          üìä Vai al Report
        </a>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <!-- Instruction Banner -->
    <div class="instruction-banner" id="instructionBanner">
      <div class="instruction-icon">üí°</div>
      <div class="instruction-content">
        <div class="instruction-title">Come funziona il Live Monitor</div>
        <div class="instruction-text">Interagisci con il sito nella <strong>finestra del browser appena aperta</strong> per vedere comparire gli eventi di tracking qui sotto in tempo reale. Clicca, scrolla, compila form e osserva quali dati vengono inviati.</div>
      </div>
      <button class="instruction-close" onclick="closeBanner()">√ó</button>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-header">üìä Eventi Totali</div>
        <div class="stat-value" id="statTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-header">üåê Network</div>
        <div class="stat-value" id="statNetwork">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-header">üì¶ DataLayer</div>
        <div class="stat-value" id="statDataLayer">0</div>
      </div>
      <div class="stat-card highlight">
        <div class="stat-header">üìù Form Events</div>
        <div class="stat-value" id="statForm">0</div>
      </div>
    </div>

    <!-- Tracker Summary -->
    <div class="tracker-summary" id="trackerSummary">
      <!-- Populated dynamically -->
    </div>

    <!-- Event Feed -->
    <div class="section-header">
      <div class="section-title">
        <span class="live-indicator"></span>
        Eventi Live
      </div>
    </div>

    <div class="event-feed" id="eventFeed">
      <div class="empty-state">
        <div class="empty-icon">üì°</div>
        <div class="empty-title">In attesa di eventi</div>
        <div class="empty-text">Interagisci con il sito nella finestra del browser per vedere gli eventi di tracking qui.</div>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="toast-icon" id="toastIcon">‚úÖ</div>
    <div class="toast-content">
      <div class="toast-title" id="toastTitle">Titolo</div>
      <div class="toast-text" id="toastText">Messaggio</div>
    </div>
  </div>

  <!-- Selection Action Bar -->
  <div class="selection-bar" id="selectionBar">
    <div class="selection-info">
      <span class="selection-count" id="selectionCount">0</span>
      <span>eventi selezionati</span>
    </div>
    <div class="selection-actions">
      <button class="btn btn-ghost" onclick="deselectAll()">
        Deseleziona
      </button>
      <button class="btn btn-success" onclick="addSelectedToReport()" id="addToReportBtn">
        üìã Aggiungi al Report
      </button>
    </div>
  </div>

  <script>
    // State
    let events = [];
    let sessionId = '';
    let eventSource = null;
    let activeFilter = null;
    let targetUrl = '';
    let reportId = '';
    let selectedEvents = new Set(); // Track selected event IDs
    let isHeadlessMode = false; // True when running on Railway

    const TRACKER_ICONS = {
      'Facebook Pixel': { icon: 'f', class: 'facebook' },
      'Facebook SDK': { icon: 'f', class: 'facebook' },
      'GA4': { icon: 'G', class: 'ga4' },
      'GTM': { icon: 'T', class: 'gtm' },
      'Clarity': { icon: 'C', class: 'clarity' },
      'Cookiebot': { icon: 'üç™', class: 'cookiebot' },
      'LinkedIn Insight': { icon: 'in', class: 'linkedin' },
      'DataLayer': { icon: '{ }', class: 'datalayer' },
      'Google Ads': { icon: 'G', class: 'ga4' },
      'Bing Ads': { icon: 'B', class: 'default' },
      'Hotjar': { icon: 'H', class: 'default' },
      'TikTok Pixel': { icon: 'T', class: 'default' },
    };

    const FORM_EVENTS = ['form_submit', 'generate_lead', 'Lead', 'Purchase', 'CompleteRegistration', 'Contact'];

    // Init
    async function init() {
      const params = new URLSearchParams(window.location.search);
      targetUrl = params.get('url');
      reportId = params.get('reportId');

      if (!targetUrl) {
        hideLoading();
        showToast('Errore', 'URL mancante nei parametri', 'danger');
        return;
      }

      document.getElementById('urlDisplay').textContent = targetUrl;

      // Show report link if we have a reportId
      if (reportId) {
        const reportBtn = document.getElementById('viewReportBtn');
        reportBtn.href = `/report.html?id=${reportId}`;
        reportBtn.style.display = 'flex';
      }

      // Check environment to decide which mode to use
      try {
        const envResponse = await fetch('/api/environment');
        const envData = await envResponse.json();

        if (envData.success && !envData.isLocal) {
          // Server mode (Railway) - use headless
          isHeadlessMode = true;
          showHeadlessUI();
          await startHeadlessSession(targetUrl);
        } else {
          // Local mode - use visual browser
          isHeadlessMode = false;
          await startSession(targetUrl);
        }
      } catch (err) {
        // Fallback to visual mode
        console.error('Errore check environment:', err);
        await startSession(targetUrl);
      }
    }

    async function startSession(url) {
      try {
        const response = await fetch('/api/form-test/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        const data = await response.json();

        if (!data.success) {
          const errorMsg = data.error || 'Errore avvio sessione';
          if (errorMsg.includes('LIVE_MONITOR_NOT_AVAILABLE')) {
            hideLoading();
            showServerNotSupportedMessage();
            return;
          }
          throw new Error(errorMsg);
        }

        sessionId = data.sessionId;
        connectToEventStream(sessionId);

      } catch (err) {
        console.error('Errore avvio sessione:', err);
        hideLoading();

        // Check if Live Monitor not available on server
        if (err.message && err.message.includes('LIVE_MONITOR_NOT_AVAILABLE')) {
          showServerNotSupportedMessage();
        } else {
          showToast('Errore', err.message, 'danger');
        }
      }
    }

    function connectToEventStream(sid) {
      eventSource = new EventSource(`/api/form-test/${sid}/events`);

      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleEvent(data);
        } catch (e) {
          console.error('Errore parsing SSE:', e);
        }
      };

      eventSource.onerror = () => {
        updateStatus('disconnected', 'Disconnesso');
      };
    }

    function handleEvent(event) {
      const { type } = event;

      if (type === 'connected') {
        updateStatus('connecting', 'Connesso SSE');
        return;
      }

      if (type === 'session_started') {
        hideLoading();
        updateStatus('connected', 'Browser Attivo');
        showToast('Sessione Avviata', 'Interagisci con il sito per vedere gli eventi', 'success');
        return;
      }

      if (type === 'session_stopped') {
        updateStatus('disconnected', 'Sessione terminata');
        return;
      }

      if (type === 'error') {
        hideLoading();
        showToast('Errore', event.message, 'danger');
        return;
      }

      // Network & DataLayer events
      if (type === 'network' || type === 'dataLayer') {
        const eventObj = {
          id: events.length,
          type: type,
          tracker: event.tracker || (type === 'dataLayer' ? 'DataLayer' : 'Unknown'),
          event: event.event || event.data?.event || null,
          eventCategory: event.eventCategory || 'custom',
          url: event.url || '',
          timestamp: event.timestamp || Date.now(),
          isNew: true
        };

        events.unshift(eventObj); // Add to beginning
        updateUI();

        // Remove "new" status after animation
        setTimeout(() => {
          eventObj.isNew = false;
        }, 500);

        // Check for form events
        if (eventObj.event && FORM_EVENTS.some(fe =>
          eventObj.event.toLowerCase().includes(fe.toLowerCase())
        )) {
          showToast('Form Event', `${eventObj.tracker}: ${eventObj.event}`, 'success');
        }
      }
    }

    function updateStatus(status, text) {
      const badge = document.getElementById('statusBadge');
      badge.className = `status-badge ${status}`;
      document.getElementById('statusText').textContent = text;
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    function showServerNotSupportedMessage() {
      // This is now handled by headless mode - kept for backwards compatibility
      updateStatus('disconnected', 'Non disponibile');
    }

    // === HEADLESS MODE FUNCTIONS ===
    function showHeadlessUI() {
      // Update instruction banner for headless mode
      document.getElementById('instructionBanner').innerHTML = `
        <div class="instruction-icon">ü§ñ</div>
        <div class="instruction-content">
          <div class="instruction-title">Modalit√† Automatica (Server)</div>
          <div class="instruction-text">Stai usando la versione server. Usa i <strong>pulsanti azione</strong> qui sotto per interagire con la pagina e vedere gli eventi catturati in tempo reale.</div>
        </div>
        <button class="instruction-close" onclick="closeBanner()">√ó</button>
      `;

      // Add action panel after stats grid
      const statsGrid = document.querySelector('.stats-grid');
      const actionPanel = document.createElement('div');
      actionPanel.id = 'actionPanel';
      actionPanel.innerHTML = `
        <div style="background: var(--surface); border: 2px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 24px;">
          <h4 style="color: var(--primary); margin-bottom: 8px; font-size: 16px; font-weight: 700;">
            Pannello Comandi
          </h4>
          <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 20px; line-height: 1.5;">
            Usa questi pulsanti per simulare le interazioni utente sulla pagina. Ogni azione viene eseguita sul browser in background e gli eventi di tracking catturati appariranno nella lista sottostante.
          </p>

          <!-- STEP 1: Cookie -->
          <div style="background: linear-gradient(135deg, rgba(6, 232, 159, 0.08) 0%, rgba(28, 55, 56, 0.04) 100%); border: 1px solid var(--accent); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
              <span style="background: var(--accent); color: var(--primary); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; flex-shrink: 0;">1</span>
              <div style="flex: 1;">
                <h5 style="color: var(--primary); font-size: 14px; font-weight: 600; margin-bottom: 4px;">Accetta i Cookie</h5>
                <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 10px;">Clicca sul banner cookie per accettare e attivare i tracker. Questo simula l'azione dell'utente che accetta il consenso.</p>
                <button class="btn btn-primary" onclick="executeAction('acceptCookies')" id="btnAcceptCookies">
                  Accetta Cookie
                </button>
              </div>
            </div>
          </div>

          <!-- STEP 2: Navigate -->
          <div style="background: var(--surface-2); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
              <span style="background: var(--primary); color: #fff; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; flex-shrink: 0;">2</span>
              <div style="flex: 1;">
                <h5 style="color: var(--primary); font-size: 14px; font-weight: 600; margin-bottom: 4px;">Naviga la Pagina</h5>
                <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 10px;">Simula lo scroll dell'utente per attivare eventi come scroll tracking, lazy loading, e impression dei contenuti.</p>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  <button class="btn btn-ghost" onclick="executeAction('scroll', {amount: 500})">
                    Scroll (500px)
                  </button>
                  <button class="btn btn-ghost" onclick="executeAction('scrollToBottom')">
                    Vai a Fine Pagina
                  </button>
                  <button class="btn btn-ghost" onclick="executeAction('wait', {ms: 3000})">
                    Attendi 3 secondi
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- STEP 3: Form Test -->
          <div style="background: var(--surface-2); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
              <span style="background: var(--primary); color: #fff; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; flex-shrink: 0;">3</span>
              <div style="flex: 1;">
                <h5 style="color: var(--primary); font-size: 14px; font-weight: 600; margin-bottom: 4px;">Testa i Form</h5>
                <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 10px;">Compila automaticamente i form con dati di test e inviali per verificare gli eventi di conversione (generate_lead, form_submit, ecc.).</p>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  <button class="btn btn-ghost" onclick="executeAction('fillForm')">
                    Compila Form
                  </button>
                  <button class="btn btn-primary" onclick="executeAction('submitForm')">
                    Invia Form
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- STEP 4: Custom Click -->
          <div style="background: var(--surface-2); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
              <span style="background: var(--primary); color: #fff; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; flex-shrink: 0;">4</span>
              <div style="flex: 1;">
                <h5 style="color: var(--primary); font-size: 14px; font-weight: 600; margin-bottom: 4px;">Click Personalizzato</h5>
                <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 10px;">Clicca su un elemento specifico usando un selettore CSS. Utile per testare pulsanti WhatsApp, telefono, CTA specifiche.</p>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  <input type="text" id="customSelector" placeholder="es: .btn-whatsapp, a[href*='tel:'], #cta-button"
                    style="flex: 1; min-width: 200px; padding: 10px 14px; border: 2px solid var(--border); border-radius: 8px; font-size: 13px; background: var(--bg);">
                  <button class="btn btn-ghost" onclick="executeAction('click', {selector: document.getElementById('customSelector').value})">
                    Esegui Click
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Screenshot -->
          <div style="background: var(--surface-2); border: 1px solid var(--border); border-radius: 12px; padding: 16px;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
              <span style="background: var(--text-muted); color: #fff; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0;">üì∑</span>
              <div style="flex: 1;">
                <h5 style="color: var(--primary); font-size: 14px; font-weight: 600; margin-bottom: 4px;">Cattura Screenshot</h5>
                <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 10px;">Scatta una foto della pagina corrente per vedere lo stato attuale del sito nel browser headless.</p>
                <button class="btn btn-ghost" onclick="executeAction('screenshot')">
                  Scatta Screenshot
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Screenshot Preview -->
        <div id="screenshotPreview" style="display: none; background: var(--surface); border: 2px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 24px;">
          <h5 style="color: var(--primary); font-size: 14px; font-weight: 600; margin-bottom: 12px;">Anteprima Screenshot</h5>
          <img id="screenshotImg" style="max-width: 100%; border-radius: 8px; border: 1px solid var(--border);">
        </div>

        <!-- Actions Log -->
        <div id="actionsLog" style="background: var(--surface); border: 2px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 24px;">
          <h5 style="color: var(--primary); font-size: 14px; font-weight: 600; margin-bottom: 4px;">Cronologia Azioni</h5>
          <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 12px;">Registro delle azioni eseguite sul browser.</p>
          <div id="actionsLogContent" style="font-family: 'DM Sans', monospace; font-size: 12px; color: var(--text-secondary); max-height: 150px; overflow-y: auto; background: var(--bg); padding: 12px; border-radius: 8px;">
            In attesa della prima azione...
          </div>
        </div>
      `;
      statsGrid.parentNode.insertBefore(actionPanel, statsGrid.nextSibling);
    }

    async function startHeadlessSession(url) {
      try {
        const response = await fetch('/api/form-test-headless/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Errore avvio sessione headless');
        }

        sessionId = data.sessionId;
        connectToHeadlessEventStream(sessionId);

      } catch (err) {
        console.error('Errore avvio sessione headless:', err);
        hideLoading();
        showToast('Errore', err.message, 'danger');
      }
    }

    function connectToHeadlessEventStream(sid) {
      eventSource = new EventSource(`/api/form-test-headless/${sid}/events`);

      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleHeadlessEvent(data);
        } catch (e) {
          console.error('Errore parsing SSE:', e);
        }
      };

      eventSource.onerror = () => {
        updateStatus('disconnected', 'Disconnesso');
      };
    }

    function handleHeadlessEvent(event) {
      const { type } = event;

      if (type === 'connected') {
        updateStatus('connecting', 'Connesso SSE');
        return;
      }

      if (type === 'session_started') {
        hideLoading();
        updateStatus('connected', 'Headless Attivo');
        showToast('Sessione Avviata', 'Browser headless pronto. Usa le azioni per interagire.', 'success');
        return;
      }

      if (type === 'session_stopped') {
        updateStatus('disconnected', 'Sessione terminata');
        return;
      }

      if (type === 'error') {
        hideLoading();
        showToast('Errore', event.message, 'danger');
        return;
      }

      if (type === 'action') {
        logActionToUI(event.action);
        return;
      }

      // Network & DataLayer events
      if (type === 'network' || type === 'dataLayer') {
        const eventObj = {
          id: events.length,
          type: type,
          tracker: event.tracker || (type === 'dataLayer' ? 'DataLayer' : 'Unknown'),
          event: event.event || event.data?.event || null,
          eventCategory: event.eventCategory || 'custom',
          url: event.url || '',
          timestamp: event.timestamp || Date.now(),
          isNew: true
        };

        events.unshift(eventObj);
        updateUI();

        setTimeout(() => {
          eventObj.isNew = false;
        }, 500);

        if (eventObj.event && FORM_EVENTS.some(fe =>
          eventObj.event.toLowerCase().includes(fe.toLowerCase())
        )) {
          showToast('Form Event', `${eventObj.tracker}: ${eventObj.event}`, 'success');
        }
      }
    }

    function logActionToUI(action) {
      const logContent = document.getElementById('actionsLogContent');
      if (!logContent) return;

      const time = new Date().toLocaleTimeString('it-IT');
      const entry = document.createElement('div');
      entry.style.cssText = 'padding: 4px 0; border-bottom: 1px solid var(--border);';
      entry.innerHTML = `<span style="color: var(--text-muted);">${time}</span> ‚Üí ${action}`;

      if (logContent.textContent === 'In attesa di azioni...') {
        logContent.innerHTML = '';
      }
      logContent.insertBefore(entry, logContent.firstChild);
    }

    async function executeAction(actionName, params = {}) {
      if (!sessionId) {
        showToast('Errore', 'Sessione non attiva', 'danger');
        return;
      }

      try {
        showToast('Azione', `Esecuzione: ${actionName}...`, 'warning');

        const response = await fetch(`/api/form-test-headless/${sessionId}/action`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: actionName, params })
        });

        const result = await response.json();

        if (result.success) {
          showToast('Completato', result.message || actionName, 'success');

          // Handle screenshot
          if (result.screenshot) {
            const preview = document.getElementById('screenshotPreview');
            const img = document.getElementById('screenshotImg');
            if (preview && img) {
              img.src = result.screenshot;
              preview.style.display = 'block';
            }
          }
        } else {
          showToast('Errore', result.error || 'Azione fallita', 'danger');
        }
      } catch (err) {
        showToast('Errore', err.message, 'danger');
      }
    }

    async function stopHeadlessSession() {
      if (sessionId) {
        try {
          await fetch(`/api/form-test-headless/${sessionId}/stop`, { method: 'POST' });
        } catch (e) {
          console.error('Errore stop:', e);
        }
      }
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
      updateStatus('disconnected', 'Sessione terminata');
      showToast('Sessione Chiusa', 'Browser headless chiuso', 'warning');
    }

    function updateUI() {
      updateStats();
      updateTrackerSummary();
      updateEventFeed();
    }

    function updateStats() {
      const networkEvents = events.filter(e => e.type === 'network');
      const dataLayerEvents = events.filter(e => e.type === 'dataLayer');
      const formEvents = events.filter(e =>
        e.event && FORM_EVENTS.some(fe => e.event.toLowerCase().includes(fe.toLowerCase()))
      );

      document.getElementById('statTotal').textContent = events.length;
      document.getElementById('statNetwork').textContent = networkEvents.length;
      document.getElementById('statDataLayer').textContent = dataLayerEvents.length;
      document.getElementById('statForm').textContent = formEvents.length;
    }

    function updateTrackerSummary() {
      const trackerCounts = {};
      events.forEach(e => {
        const tracker = e.tracker || 'Unknown';
        trackerCounts[tracker] = (trackerCounts[tracker] || 0) + 1;
      });

      const container = document.getElementById('trackerSummary');

      if (Object.keys(trackerCounts).length === 0) {
        container.innerHTML = '';
        return;
      }

      // Sort by count
      const sorted = Object.entries(trackerCounts).sort((a, b) => b[1] - a[1]);

      container.innerHTML = sorted.map(([tracker, count]) => {
        const isActive = activeFilter === tracker;
        return `
          <div class="tracker-chip ${isActive ? 'active' : ''}" onclick="filterByTracker('${tracker}')">
            ${tracker}
            <span class="count">${count}</span>
          </div>
        `;
      }).join('') + `
        <div class="tracker-chip ${activeFilter === null ? 'active' : ''}" onclick="filterByTracker(null)">
          Tutti
          <span class="count">${events.length}</span>
        </div>
      `;
    }

    function filterByTracker(tracker) {
      activeFilter = tracker;
      updateTrackerSummary();
      updateEventFeed();
    }

    function updateEventFeed() {
      const container = document.getElementById('eventFeed');

      let filteredEvents = events;
      if (activeFilter) {
        filteredEvents = events.filter(e => e.tracker === activeFilter);
      }

      if (filteredEvents.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì°</div>
            <div class="empty-title">In attesa di eventi</div>
            <div class="empty-text">Interagisci con il sito nella finestra del browser per vedere gli eventi di tracking qui.</div>
          </div>
        `;
        return;
      }

      // Show last 50 events
      const displayEvents = filteredEvents.slice(0, 50);

      // Build select all row
      const allSelected = displayEvents.every(e => selectedEvents.has(e.id));
      const someSelected = displayEvents.some(e => selectedEvents.has(e.id));
      const selectAllClass = allSelected ? 'checked' : (someSelected ? 'partial' : '');

      let html = `
        <div class="select-all-row">
          <div class="select-all-left">
            <div class="select-all-checkbox ${selectAllClass}" onclick="toggleSelectAll()"></div>
            <span class="select-all-label" onclick="toggleSelectAll()">Seleziona tutti (${displayEvents.length})</span>
          </div>
        </div>
      `;

      html += displayEvents.map(e => {
        const iconInfo = TRACKER_ICONS[e.tracker] || { icon: '?', class: 'default' };
        const time = new Date(e.timestamp).toLocaleTimeString('it-IT');
        const shortUrl = e.url ? e.url.substring(0, 80) + (e.url.length > 80 ? '...' : '') : '';
        const isSelected = selectedEvents.has(e.id);

        return `
          <div class="event-card ${e.isNew ? 'new' : ''} ${isSelected ? 'selected' : ''}" onclick="toggleSelection(${e.id})">
            <div class="event-checkbox"></div>
            <div class="tracker-icon ${iconInfo.class}">${iconInfo.icon}</div>
            <div class="event-content">
              <div class="event-header">
                <span class="event-tracker">${e.tracker}</span>
                ${e.event ? `<span class="event-name">${e.event}</span>` : ''}
                <span class="event-category">${e.eventCategory}</span>
              </div>
              ${shortUrl ? `<div class="event-url">${shortUrl}</div>` : ''}
            </div>
            <div class="event-time">${time}</div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
      updateSelectionBar();
    }

    function showToast(title, text, type = 'success') {
      const toast = document.getElementById('toast');
      const icons = { success: '‚úÖ', warning: '‚ö†Ô∏è', danger: '‚ùå' };

      document.getElementById('toastIcon').textContent = icons[type] || 'üì¢';
      document.getElementById('toastTitle').textContent = title;
      document.getElementById('toastText').textContent = text;

      toast.className = `toast show ${type}`;

      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    function clearEvents() {
      events = [];
      activeFilter = null;
      selectedEvents.clear();
      updateUI();
    }

    function closeBanner() {
      document.getElementById('instructionBanner').classList.add('hidden');
    }

    // Selection functions
    function toggleSelection(eventId) {
      if (selectedEvents.has(eventId)) {
        selectedEvents.delete(eventId);
      } else {
        selectedEvents.add(eventId);
      }
      updateEventFeed();
    }

    function toggleSelectAll() {
      let filteredEvents = events;
      if (activeFilter) {
        filteredEvents = events.filter(e => e.tracker === activeFilter);
      }
      const displayEvents = filteredEvents.slice(0, 50);

      const allSelected = displayEvents.every(e => selectedEvents.has(e.id));

      if (allSelected) {
        // Deselect all
        displayEvents.forEach(e => selectedEvents.delete(e.id));
      } else {
        // Select all
        displayEvents.forEach(e => selectedEvents.add(e.id));
      }
      updateEventFeed();
    }

    function deselectAll() {
      selectedEvents.clear();
      updateEventFeed();
    }

    function updateSelectionBar() {
      const bar = document.getElementById('selectionBar');
      const count = selectedEvents.size;
      const countEl = document.getElementById('selectionCount');
      const addBtn = document.getElementById('addToReportBtn');

      countEl.textContent = count;

      if (count > 0) {
        bar.classList.add('show');
        // Update button text based on whether we have a reportId
        if (reportId) {
          addBtn.textContent = 'üìã Aggiungi al Report';
        } else {
          addBtn.textContent = 'üíæ Scarica Selezione';
        }
      } else {
        bar.classList.remove('show');
      }
    }

    async function addSelectedToReport() {
      if (selectedEvents.size === 0) return;

      // Get selected events data
      const selectedData = events.filter(e => selectedEvents.has(e.id));

      if (reportId) {
        // Add to existing report
        try {
          // Count specific form events
          const formSubmitCount = selectedData.filter(e =>
            e.event && e.event.toLowerCase().includes('form_submit')
          ).length;
          const generateLeadCount = selectedData.filter(e =>
            e.event && (e.event.toLowerCase().includes('generate_lead') || e.event === 'Lead')
          ).length;

          const results = {
            url: targetUrl,
            timestamp: new Date().toISOString(),
            events: selectedData.map(e => ({
              type: e.type,
              timestamp: e.timestamp || Date.now(),
              data: { tracker: e.tracker, event: e.event, url: e.url }
            })),
            formEventCounts: {
              total: selectedData.length,
              form_submit: formSubmitCount,
              generate_lead: generateLeadCount
            },
            success: selectedData.length > 0
          };

          const response = await fetch(`/api/report/${reportId}/form-test`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(results)
          });

          const data = await response.json();

          if (data.success) {
            showToast('Aggiunto al Report', `${data.eventsAdded} eventi aggiunti`, 'success');
            // Notify report page to refresh via BroadcastChannel
            try {
              const channel = new BroadcastChannel('audit-report-update');
              channel.postMessage({ type: 'form-test-updated', reportId: reportId });
              channel.close();
            } catch (e) {
              // BroadcastChannel not supported, fallback to localStorage
              localStorage.setItem('audit-report-update', JSON.stringify({
                type: 'form-test-updated',
                reportId: reportId,
                timestamp: Date.now()
              }));
            }
            // Clear selection after successful add
            selectedEvents.clear();
            updateEventFeed();
            return;
          } else {
            throw new Error(data.error || 'Errore');
          }
        } catch (err) {
          console.error('Errore salvataggio:', err);
          showToast('Errore', err.message, 'danger');
        }
      } else {
        // No reportId - download as JSON
        const exportData = {
          url: targetUrl,
          timestamp: new Date().toISOString(),
          selectedEvents: selectedData.map(e => ({
            tracker: e.tracker,
            event: e.event,
            eventCategory: e.eventCategory,
            type: e.type,
            url: e.url,
            timestamp: e.timestamp
          }))
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `selected-events-${Date.now()}.json`;
        a.click();
        showToast('Download', `${selectedData.length} eventi esportati`, 'success');
      }
    }

    async function stopSession() {
      if (sessionId) {
        try {
          // Use correct endpoint based on mode
          const endpoint = isHeadlessMode
            ? `/api/form-test-headless/${sessionId}/stop`
            : `/api/form-test/${sessionId}/stop`;
          await fetch(endpoint, { method: 'POST' });
        } catch (e) {
          console.error('Errore stop:', e);
        }
      }
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
      updateStatus('disconnected', 'Sessione terminata');
      showToast('Sessione Chiusa', 'Il browser √® stato chiuso', 'warning');
    }

    async function saveResults() {
      const results = {
        url: targetUrl,
        timestamp: new Date().toISOString(),
        events: events.map(e => ({
          type: e.type,
          data: { tracker: e.tracker, event: e.event, url: e.url }
        })),
        formEventCounts: { total: events.filter(e =>
          e.event && FORM_EVENTS.some(fe => e.event.toLowerCase().includes(fe.toLowerCase()))
        ).length },
        success: true
      };

      if (reportId) {
        try {
          const response = await fetch(`/api/report/${reportId}/form-test`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(results)
          });

          const data = await response.json();

          if (data.success) {
            showToast('Salvato', `${data.eventsAdded} eventi aggiunti al report`, 'success');
            return;
          }
        } catch (e) {
          console.error('Errore salvataggio:', e);
        }
      }

      // Fallback: download JSON
      const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `live-events-${Date.now()}.json`;
      a.click();
      showToast('Scaricato', 'File JSON salvato', 'success');
    }

    // Cleanup on page close
    window.addEventListener('beforeunload', () => {
      if (sessionId) {
        const endpoint = isHeadlessMode
          ? `/api/form-test-headless/${sessionId}/stop`
          : `/api/form-test/${sessionId}/stop`;
        navigator.sendBeacon(endpoint, '');
      }
    });

    // Start
    init();
  </script>
</body>
</html>
