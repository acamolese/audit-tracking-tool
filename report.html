<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report Audit</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1c3738;
      --primary-light: #2a4a4b;
      --accent: #06e89f;
      --accent-hover: #05c989;
      --danger: #ff4f50;
      --warning: #ffb84d;
      --success: #06e89f;
      --bg: #f3f1ee;
      --bg-dark: #1c3738;
      --text: #111d0c;
      --text-light: #5a6a5c;
      --white: #ffffff;
      --border-radius: 16px;
      --shadow: 0 4px 24px rgba(28, 55, 56, 0.08);
      --shadow-lg: 0 8px 40px rgba(28, 55, 56, 0.12);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--primary);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1320px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-family: 'DM Serif Display', serif;
      font-size: 22px;
      color: var(--white);
      text-decoration: none;
    }

    .logo span {
      color: var(--accent);
    }

    /* Navigation */
    .nav-links {
      display: flex;
      gap: 24px;
    }

    .nav-links a {
      color: var(--white);
      text-decoration: none;
      font-size: 14px;
      opacity: 0.8;
      transition: opacity 0.2s;
      padding: 8px 0;
    }

    .nav-links a:hover,
    .nav-links a.active {
      opacity: 1;
    }

    .nav-links a.active {
      border-bottom: 2px solid var(--accent);
    }

    /* Mobile menu button */
    .menu-toggle {
      display: none;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
    }

    .menu-toggle span {
      display: block;
      width: 24px;
      height: 2px;
      background: var(--white);
      margin: 5px 0;
      transition: 0.3s;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn-header {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .btn-outline {
      background: transparent;
      color: var(--white);
      border: 2px solid rgba(255,255,255,0.3);
    }

    .btn-outline:hover {
      border-color: var(--white);
      background: rgba(255,255,255,0.1);
    }

    .btn-accent {
      background: var(--accent);
      color: var(--primary);
    }

    .btn-accent:hover {
      background: var(--accent-hover);
    }

    /* Main */
    .main {
      max-width: 1000px;
      margin: 0 auto;
      padding: 40px 24px 80px;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 100px 24px;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--primary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 24px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Verdict Banner */
    .verdict-banner {
      padding: 32px 40px;
      border-radius: var(--border-radius);
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .verdict-banner.success {
      background: linear-gradient(135deg, #06e89f 0%, #05c989 100%);
      color: var(--primary);
    }

    .verdict-banner.danger {
      background: linear-gradient(135deg, #ff4f50 0%, #e63e3f 100%);
      color: var(--white);
    }

    .verdict-banner.warning {
      background: linear-gradient(135deg, #ffb84d 0%, #f5a623 100%);
      color: var(--primary);
    }

    .verdict-icon {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      flex-shrink: 0;
    }

    .verdict-content h2 {
      font-family: 'DM Serif Display', serif;
      font-size: 32px;
      font-weight: 400;
      margin-bottom: 8px;
    }

    .verdict-content p {
      font-size: 16px;
      opacity: 0.9;
    }

    /* Meta info */
    .meta-info {
      display: flex;
      gap: 32px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-light);
    }

    .meta-item strong {
      color: var(--text);
    }

    /* Cards */
    .card {
      background: var(--white);
      border-radius: var(--border-radius);
      padding: 32px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      cursor: pointer;
    }

    .card-title {
      font-family: 'DM Serif Display', serif;
      font-size: 24px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-title .icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .card-title .icon.green { background: rgba(6, 232, 159, 0.15); }
    .card-title .icon.red { background: rgba(255, 79, 80, 0.15); }
    .card-title .icon.blue { background: rgba(0, 109, 255, 0.15); }
    .card-title .icon.purple { background: rgba(182, 136, 255, 0.15); }

    .badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .badge-success { background: rgba(6, 232, 159, 0.15); color: #05a06d; }
    .badge-danger { background: rgba(255, 79, 80, 0.15); color: var(--danger); }
    .badge-neutral { background: var(--bg); color: var(--text-light); }

    /* Lists */
    .item-list {
      list-style: none;
    }

    .item-list li {
      padding: 16px 20px;
      background: var(--bg);
      border-radius: 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 15px;
    }

    .item-list li:last-child {
      margin-bottom: 0;
    }

    .item-list .tracker-name {
      font-weight: 600;
      color: var(--primary);
      min-width: 140px;
    }

    .item-list .tracker-detail {
      color: var(--text-light);
      font-size: 13px;
      word-break: break-all;
    }

    .item-list .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .item-list .dot.red { background: var(--danger); }
    .item-list .dot.green { background: var(--success); }
    .item-list .dot.gray { background: #ccc; }
    .item-list .dot.blue { background: #006dff; }
    .item-list .dot.purple { background: #8b5cf6; }
    .item-list .dot.orange { background: #f59e0b; }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .stat-item {
      padding: 24px;
      background: var(--bg);
      border-radius: 12px;
      text-align: center;
    }

    .stat-value {
      font-family: 'DM Serif Display', serif;
      font-size: 36px;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-light);
    }

    /* Collapsible */
    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 16px 0;
      border-top: 1px solid #eee;
      margin-top: 24px;
    }

    .collapsible-header h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
    }

    .collapsible-header .arrow {
      transition: transform 0.2s ease;
    }

    .collapsible-header.open .arrow {
      transform: rotate(180deg);
    }

    .collapsible-content {
      display: none;
      padding-top: 16px;
    }

    .collapsible-content.open {
      display: block;
    }

    /* Code block */
    .code-block {
      background: var(--primary);
      color: var(--accent);
      padding: 20px;
      border-radius: 12px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 13px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-light);
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Footer actions */
    .footer-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 48px;
    }

    .btn {
      padding: 16px 32px;
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--primary);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--white);
      color: var(--primary);
      border: 2px solid #e5e5e5;
    }

    .btn-secondary:hover {
      border-color: var(--primary);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        padding: 14px 16px;
      }

      .logo {
        font-size: 20px;
      }

      .menu-toggle {
        display: block;
      }

      .nav-links {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--primary);
        flex-direction: column;
        padding: 16px 24px;
        gap: 0;
        border-top: 1px solid rgba(255,255,255,0.1);
      }

      .nav-links.open {
        display: flex;
      }

      .nav-links a {
        padding: 12px 0;
        border-bottom: 1px solid rgba(255,255,255,0.1);
      }

      .nav-links a:last-child {
        border-bottom: none;
      }

      .nav-links a.active {
        border-bottom: 1px solid rgba(255,255,255,0.1);
      }

      .header-actions {
        display: none;
      }

      .verdict-banner {
        flex-direction: column;
        text-align: center;
        padding: 24px;
      }

      .verdict-content h2 {
        font-size: 24px;
      }

      .meta-info {
        flex-direction: column;
        gap: 12px;
      }

      .main {
        padding: 32px 16px 60px;
      }

      .card {
        padding: 24px 20px;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }

      .item-list li {
        flex-direction: column;
        align-items: flex-start;
      }

      .item-list .tracker-name {
        min-width: auto;
      }

      .footer-actions {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 380px) {
      .verdict-content h2 {
        font-size: 20px;
      }

      .card {
        padding: 20px 16px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    @media print {
      .header, .footer-actions { display: none; }
      .card { box-shadow: none; border: 1px solid #eee; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <a href="/" class="logo"><span>Audit</span>TrackingTool</a>
      <button class="menu-toggle" id="menuToggle" aria-label="Menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <nav class="nav-links" id="navLinks">
        <a href="/">Scansione</a>
        <a href="/bulk-scan.html">Bulk Scan</a>
      </nav>
    </div>
  </header>

  <main class="main">
    <!-- Loading -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>Caricamento report...</p>
    </div>

    <!-- Report Content -->
    <div id="report" style="display:none;">

      <!-- Verdict Banner -->
      <div id="verdictBanner" class="verdict-banner">
        <div class="verdict-icon" id="verdictIcon"></div>
        <div class="verdict-content">
          <h2 id="verdictTitle"></h2>
          <p id="verdictDesc"></p>
        </div>
      </div>

      <!-- Meta Info -->
      <div class="meta-info">
        <div class="meta-item">
          <span>URL:</span>
          <strong id="reportUrl"></strong>
        </div>
        <div class="meta-item">
          <span>Data:</span>
          <strong id="reportDate"></strong>
        </div>
      </div>

      <!-- CMP Status -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <span class="icon green">&#128274;</span>
            Consent Management Platform
          </h3>
          <span id="cmpBadge" class="badge"></span>
        </div>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="cmpDetected">-</div>
            <div class="stat-label">CMP Rilevato</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="blockedScripts">0</div>
            <div class="stat-label">Script Bloccati</div>
          </div>
        </div>
        <div class="collapsible-header" onclick="toggleCollapsible(this)">
          <h4>Stato Consenso Post-Click</h4>
          <span class="arrow">&#9660;</span>
        </div>
        <div class="collapsible-content">
          <div class="code-block" id="consentState">{}</div>
        </div>
      </div>

      <!-- Violations -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <span class="icon red">&#9888;</span>
            Potenziali Violazioni
          </h3>
          <span id="violationsBadge" class="badge"></span>
        </div>
        <ul id="violationsList" class="item-list"></ul>
        <div id="violationsEmpty" class="empty-state" style="display:none;">
          <div class="icon">&#10004;</div>
          <p>Nessuna violazione rilevata</p>
        </div>
      </div>

      <!-- Eventi (tutti i tracker) -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <span class="icon blue">&#128202;</span>
            Eventi
          </h3>
          <span id="eventsBadge" class="badge badge-neutral"></span>
        </div>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="eventsPre">0</div>
            <div class="stat-label">Pre-Consenso</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="eventsPost">0</div>
            <div class="stat-label">Post-Consenso</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="eventsAutomatic">0</div>
            <div class="stat-label">Eventi Automatici</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="eventsSimulated">0</div>
            <div class="stat-label">Eventi Simulati</div>
          </div>
          <div class="stat-item" id="eventsFormTestContainer" style="display:none;">
            <div class="stat-value" id="eventsFormTest" style="color:var(--accent);">0</div>
            <div class="stat-label">Test Form</div>
          </div>
        </div>

        <div class="collapsible-header" onclick="toggleCollapsible(this)">
          <h4>Eventi per Tracker</h4>
          <span class="arrow">&#9660;</span>
        </div>
        <div class="collapsible-content">
          <div id="eventsByTracker"></div>
        </div>

        <div class="collapsible-header" onclick="toggleCollapsible(this)">
          <h4>Tutti gli Eventi Rilevati</h4>
          <span class="arrow">&#9660;</span>
        </div>
        <div class="collapsible-content">
          <ul id="allEventsList" class="item-list"></ul>
        </div>
      </div>

      <!-- Form -->
      <div class="card" id="formCard">
        <div class="card-header">
          <h3 class="card-title">
            <span class="icon green">&#128221;</span>
            Form
          </h3>
          <div style="display:flex;align-items:center;gap:12px;">
            <span id="formBadge" class="badge badge-neutral"></span>
            <button id="testFormBtn" class="btn btn-secondary" style="display:none;padding:8px 16px;font-size:13px;" onclick="openFormTest()">
              Testa Form
            </button>
          </div>
        </div>
        <ul id="formsList" class="item-list"></ul>
        <div id="formsEmpty" class="empty-state" style="display:none;">
          <div class="icon">&#128196;</div>
          <p>Nessun form valido trovato</p>
        </div>

        <!-- Risultati test form -->
        <div id="formTestResults" style="display:none;">
          <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <h4>Eventi Live Monitor (<span id="formTestCount">0</span>)</h4>
            <span class="arrow">&#9660;</span>
          </div>
          <div class="collapsible-content">
            <div class="stats-grid" style="margin-top:12px;">
              <div class="stat-item">
                <div class="stat-value" id="testFormSubmit">0</div>
                <div class="stat-label">form_submit</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="testGenerateLead">0</div>
                <div class="stat-label">generate_lead</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="testTotalEvents">0</div>
                <div class="stat-label">Totale</div>
              </div>
            </div>
            <div id="formTestVerdict" style="margin-top:16px;padding:16px;border-radius:8px;"></div>
            <h5 style="margin-top:16px;margin-bottom:8px;color:var(--text-light);font-size:13px;text-transform:uppercase;">Lista Eventi</h5>
            <ul id="formTestEventsList" class="item-list"></ul>
          </div>
        </div>
      </div>

      <!-- Cookies -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <span class="icon purple">&#127850;</span>
            Cookie
          </h3>
        </div>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="cookiesPre">0</div>
            <div class="stat-label">Pre-Consenso</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="cookiesPost">0</div>
            <div class="stat-label">Post-Consenso</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="cookiesNew">0</div>
            <div class="stat-label">Nuovi</div>
          </div>
        </div>

        <div class="collapsible-header" onclick="toggleCollapsible(this)">
          <h4>Cookie Pre-Consenso</h4>
          <span class="arrow">&#9660;</span>
        </div>
        <div class="collapsible-content">
          <ul id="cookiesPreList" class="item-list"></ul>
        </div>

        <div class="collapsible-header" onclick="toggleCollapsible(this)">
          <h4>Cookie Post-Consenso</h4>
          <span class="arrow">&#9660;</span>
        </div>
        <div class="collapsible-content">
          <ul id="cookiesPostList" class="item-list"></ul>
        </div>
      </div>

      <!-- Footer Actions -->
      <div class="footer-actions">
        <button onclick="window.print()" class="btn btn-secondary">
          &#128424; Stampa Report
        </button>
        <button onclick="downloadJson()" class="btn btn-secondary">
          &#128190; Scarica JSON
        </button>
        <button onclick="openLiveMonitor()" class="btn btn-secondary">
          &#128225; Live Monitor
        </button>
        <a href="/" class="btn btn-primary">
          &#128269; Nuova Scansione
        </a>
      </div>

      <footer style="text-align:center;padding:24px;color:var(--text-light);font-size:14px;">
        AuditTrackingTool - Realizzato da <a href="https://www.linkedin.com/in/andreacamolese/" target="_blank" style="color:inherit;text-decoration:underline;">Andrea Camolese</a>
      </footer>

    </div>
  </main>

  <script>
    let reportData = null;

    function toggleCollapsible(header) {
      header.classList.toggle('open');
      const content = header.nextElementSibling;
      content.classList.toggle('open');
    }

    async function loadReport() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');

      if (!id) {
        document.getElementById('loading').innerHTML = '<p>ID report mancante</p>';
        return;
      }

      try {
        const response = await fetch(`/api/report/${id}`);
        const data = await response.json();

        if (!data.success) {
          document.getElementById('loading').innerHTML = '<p>Report non trovato</p>';
          return;
        }

        reportData = data.report;
        renderReport(reportData);
      } catch (err) {
        document.getElementById('loading').innerHTML = '<p>Errore: ' + err.message + '</p>';
      }
    }

    function renderReport(report) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('report').style.display = 'block';

      // Meta
      document.getElementById('reportUrl').textContent = report.url;
      document.getElementById('reportDate').textContent = new Date(report.timestamp).toLocaleString('it-IT');

      // Verdict
      const violations = report.summary?.violations || 0;
      const cmpDetected = report.cmp?.detected;
      const cmpType = report.cmp?.type || 'CMP';
      const banner = document.getElementById('verdictBanner');
      const icon = document.getElementById('verdictIcon');
      const title = document.getElementById('verdictTitle');
      const desc = document.getElementById('verdictDesc');

      if (violations === 0 && cmpDetected) {
        banner.className = 'verdict-banner success';
        icon.textContent = '✓';
        title.textContent = 'Conforme';
        desc.textContent = `Il sito rispetta le normative GDPR sui cookie (${cmpType})`;
      } else if (violations > 0) {
        banner.className = 'verdict-banner danger';
        icon.textContent = '!';
        title.textContent = 'Possibile Non Conformità';
        desc.textContent = `Rilevate ${violations} potenziali violazioni pre-consenso`;
      } else {
        banner.className = 'verdict-banner warning';
        icon.textContent = '?';
        title.textContent = 'Da Verificare';
        desc.textContent = 'CMP non rilevato, verifica manuale consigliata';
      }

      // CMP
      document.getElementById('cmpDetected').textContent = cmpDetected ? cmpType : 'No';
      document.getElementById('blockedScripts').textContent = report.summary?.blockedScriptsCount || 0;
      document.getElementById('cmpBadge').textContent = cmpDetected ? cmpType : 'Non rilevato';
      document.getElementById('cmpBadge').className = 'badge ' + (cmpDetected ? 'badge-success' : 'badge-neutral');
      document.getElementById('consentState').textContent = JSON.stringify(report.cmp?.consentState || {}, null, 2);

      // Violations - raggruppa eventi pre-consenso per tracker
      const violationsList = document.getElementById('violationsList');
      const violationsEmpty = document.getElementById('violationsEmpty');

      // Raggruppa eventi pre-consenso per tracker (escludi GA4 con consent denied)
      const preConsentEvents = report.events?.preConsent || [];
      const preConsentByTracker = {};
      preConsentEvents.forEach(e => {
        // Escludi eventi GA4 con consent mode "denied" - non sono vere violazioni
        if (e.tracker === 'GA4' && e.consentMode && e.consentMode.toLowerCase().includes('denied')) {
          return;
        }
        if (!preConsentByTracker[e.tracker]) {
          preConsentByTracker[e.tracker] = [];
        }
        preConsentByTracker[e.tracker].push(e);
      });

      const totalViolations = Object.keys(preConsentByTracker).length;
      document.getElementById('violationsBadge').textContent = totalViolations + ' tracker';
      document.getElementById('violationsBadge').className = 'badge ' + (totalViolations > 0 ? 'badge-danger' : 'badge-success');

      if (totalViolations === 0) {
        violationsList.style.display = 'none';
        violationsEmpty.style.display = 'block';
      } else {
        violationsList.innerHTML = '';

        // Mostra tracker con eventi pre-consenso (box grigi espandibili)
        Object.entries(preConsentByTracker).forEach(([tracker, events]) => {
          const trackerDiv = document.createElement('div');
          trackerDiv.style.cssText = 'margin-bottom: 8px; background: var(--bg); border-radius: 8px; overflow: hidden;';

          // Header cliccabile
          const header = document.createElement('div');
          header.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 14px 16px; cursor: pointer; transition: background 0.2s;';
          header.innerHTML = `
            <span class="dot red"></span>
            <span style="font-weight: 600; color: var(--text); flex: 1;">${tracker}</span>
            <span style="font-size: 12px; color: var(--text-light);">${events.length} eventi pre-consenso</span>
            <span class="arrow" style="transition: transform 0.2s; font-size: 10px; color: var(--text-light);">&#9660;</span>
          `;

          // Contenuto espandibile (nascosto di default)
          const content = document.createElement('div');
          content.style.cssText = 'display: none; padding: 0 16px 12px 42px; font-size: 13px;';

          events.forEach(e => {
            const eventDiv = document.createElement('div');
            eventDiv.style.cssText = 'padding: 6px 0; border-bottom: 1px solid var(--border);';
            let eventInfo = `<span style="color: var(--text);">${e.event}</span>`;
            if (e.eventCategory) eventInfo += ` <span style="background: var(--surface); padding: 2px 6px; border-radius: 4px; font-size: 11px; color: var(--text-light);">${e.eventCategory}</span>`;
            eventDiv.innerHTML = eventInfo;
            content.appendChild(eventDiv);
          });

          // Toggle al click
          header.onclick = () => {
            const isOpen = content.style.display !== 'none';
            content.style.display = isOpen ? 'none' : 'block';
            header.querySelector('.arrow').style.transform = isOpen ? '' : 'rotate(180deg)';
          };

          // Hover effect
          header.onmouseenter = () => { header.style.background = 'var(--surface)'; };
          header.onmouseleave = () => { header.style.background = ''; };

          trackerDiv.appendChild(header);
          trackerDiv.appendChild(content);
          violationsList.appendChild(trackerDiv);
        });
      }

      // Cookies
      document.getElementById('cookiesPre').textContent = report.summary?.cookiesPreConsent || 0;
      document.getElementById('cookiesPost').textContent = report.summary?.cookiesPostConsent || 0;
      document.getElementById('cookiesNew').textContent = report.summary?.newCookiesAfterConsent || 0;

      const cookiesPreList = document.getElementById('cookiesPreList');
      cookiesPreList.innerHTML = '';
      (report.preConsent?.cookies || []).forEach(c => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span class="dot gray"></span>
          <span class="tracker-name">${c.name}</span>
          <span class="tracker-detail">${c.domain}</span>
        `;
        cookiesPreList.appendChild(li);
      });

      const cookiesPostList = document.getElementById('cookiesPostList');
      cookiesPostList.innerHTML = '';
      (report.postConsent?.cookies || []).forEach(c => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span class="dot gray"></span>
          <span class="tracker-name">${c.name}</span>
          <span class="tracker-detail">${c.domain}</span>
        `;
        cookiesPostList.appendChild(li);
      });

      // Eventi (tutti i tracker)
      const eventsSummary = report.summary?.events || {};
      document.getElementById('eventsPre').textContent = eventsSummary.preConsent || 0;
      document.getElementById('eventsPost').textContent = eventsSummary.postConsent || 0;
      
      // Calcola eventi automatici e simulati
      const allEventsCombined = [
        ...(report.events?.preConsent || []),
        ...(report.events?.postConsent || []),
        ...(report.events?.interactions || []),
        ...(report.events?.formTest || [])
      ];
      
      const automaticEvents = allEventsCombined.filter(e => e.source === 'automatic').length;
      const simulatedEvents = allEventsCombined.filter(e => e.source === 'simulated').length;
      
      document.getElementById('eventsAutomatic').textContent = automaticEvents;
      document.getElementById('eventsSimulated').textContent = simulatedEvents;

      // Mostra eventi form test se presenti
      const formTestEventsCount = report.events?.formTest?.length || 0;
      if (formTestEventsCount > 0) {
        document.getElementById('eventsFormTestContainer').style.display = 'block';
        document.getElementById('eventsFormTest').textContent = formTestEventsCount;
      }

      document.getElementById('eventsBadge').textContent = (eventsSummary.total || 0) + ' eventi';

      // Eventi per tracker (organizzati per categoria)
      const eventsByTrackerDiv = document.getElementById('eventsByTracker');
      eventsByTrackerDiv.innerHTML = '';
      const byTracker = eventsSummary.byTracker || {};

      const categoryLabels = {
        standard: 'Eventi Standard',
        custom: 'Eventi Custom',
        click: 'Eventi Click',
        session: 'Session Recording',
        conversion: 'Conversioni'
      };

      const categoryColors = {
        standard: 'green',
        custom: 'blue',
        click: 'purple',
        session: 'gray',
        conversion: 'orange'
      };

      if (Object.keys(byTracker).length === 0) {
        eventsByTrackerDiv.innerHTML = '<p style="text-align:center;color:#888;padding:20px;">Nessun evento rilevato</p>';
      } else {
        Object.entries(byTracker).forEach(([tracker, categories]) => {
          const trackerDiv = document.createElement('div');
          trackerDiv.style.marginBottom = '24px';
          trackerDiv.style.padding = '16px';
          trackerDiv.style.background = 'var(--bg)';
          trackerDiv.style.borderRadius = '12px';

          let categoriesHtml = '';
          Object.entries(categories).forEach(([category, events]) => {
            const label = categoryLabels[category] || category;
            const color = categoryColors[category] || 'gray';

            const eventsHtml = events.map(ev => {
              let detail = '';
              if (ev.destinationUrl) {
                detail = ev.destinationUrl.length > 50 ? ev.destinationUrl.substring(0, 50) + '...' : ev.destinationUrl;
              } else if (ev.productName) {
                detail = ev.productName;
              } else if (ev.params && Object.keys(ev.params).length > 0) {
                detail = Object.entries(ev.params).map(([k,v]) => `${k}: ${v}`).join(', ');
              }
              return `
                <li style="padding:12px 16px;">
                  <span class="dot ${color}"></span>
                  <span class="tracker-name">${ev.name}</span>
                  ${detail ? `<span class="tracker-detail">${detail}</span>` : ''}
                </li>
              `;
            }).join('');

            categoriesHtml += `
              <div style="margin-top:12px;">
                <span style="font-size:12px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-light);font-weight:600;">${label}</span>
                <ul class="item-list" style="margin-top:8px;">${eventsHtml}</ul>
              </div>
            `;
          });

          trackerDiv.innerHTML = `
            <h5 style="font-size:16px;color:var(--primary);margin-bottom:4px;font-weight:600;">${tracker}</h5>
            ${categoriesHtml}
          `;
          eventsByTrackerDiv.appendChild(trackerDiv);
        });
      }

      // Lista tutti gli eventi rilevati
      const allEventsList = document.getElementById('allEventsList');
      allEventsList.innerHTML = '';
      const allEvents = [
        ...(report.events?.preConsent || []).map(e => ({...e, phase: 'Pre'})),
        ...(report.events?.postConsent || []).map(e => ({...e, phase: 'Post'})),
        ...(report.events?.interactions || []).map(e => ({...e, phase: 'Interaction'})),
        ...(report.events?.formTest || []).map(e => ({...e, phase: 'Form Test'}))
      ];

      if (allEvents.length === 0) {
        allEventsList.innerHTML = '<li style="text-align:center;color:#888;">Nessun evento rilevato</li>';
      } else {
        allEvents.forEach(e => {
          const li = document.createElement('li');
          let dotColor = 'gray';

          if (e.phase === 'Pre') dotColor = 'gray';
          else if (e.phase === 'Post') dotColor = 'green';
          else if (e.phase === 'Interaction') dotColor = 'blue';
          else if (e.phase === 'Form Test') dotColor = 'orange';

          li.innerHTML = `
            <span class="dot ${dotColor}"></span>
            <span class="tracker-name">${e.tracker}: ${e.event}</span>
            <span class="tracker-detail">${e.phase}${e.consentMode ? ' - ' + e.consentMode : ''}</span>
          `;
          allEventsList.appendChild(li);
        });
      }

      // Form - nascosto in Fast Mode
      const formCard = document.getElementById('formCard');
      if (report.scanMode === 'fast') {
        formCard.style.display = 'none';
      } else {
        const forms = report.forms?.found || [];
        const formsList = document.getElementById('formsList');
        const formsEmpty = document.getElementById('formsEmpty');
        document.getElementById('formBadge').textContent = forms.length + ' form validi';

        if (forms.length === 0) {
          formsList.style.display = 'none';
          formsEmpty.style.display = 'block';
        } else {
        formsList.innerHTML = '';
        forms.forEach(f => {
          const li = document.createElement('li');
          const fields = [];
          if (f.hasNameField) fields.push('nome');
          if (f.hasSurnameField) fields.push('cognome');
          if (f.hasEmailField) fields.push('email');
          li.innerHTML = `
            <span class="dot green"></span>
            <span class="tracker-name">Form #${f.index + 1}</span>
            <span class="tracker-detail">Campi: ${fields.join(', ')}</span>
          `;
          formsList.appendChild(li);
        });

        // Mostra pulsante test form
        document.getElementById('testFormBtn').style.display = 'inline-block';
      }

      // Mostra risultati test form se presenti
      if (report.formTest || (report.events?.formTest && report.events.formTest.length > 0)) {
        const ft = report.formTest || {};
        const formTestEvents = report.events?.formTest || [];

        document.getElementById('formTestResults').style.display = 'block';
        document.getElementById('formTestCount').textContent = formTestEvents.length;
        document.getElementById('testFormSubmit').textContent = ft.formEventCounts?.form_submit || 0;
        document.getElementById('testFormSubmit').style.color = (ft.formEventCounts?.form_submit > 0) ? 'var(--success)' : 'var(--text)';
        document.getElementById('testGenerateLead').textContent = ft.formEventCounts?.generate_lead || 0;
        document.getElementById('testGenerateLead').style.color = (ft.formEventCounts?.generate_lead > 0) ? 'var(--success)' : 'var(--text)';
        document.getElementById('testTotalEvents').textContent = formTestEvents.length;
        document.getElementById('testTotalEvents').style.color = (formTestEvents.length > 0) ? 'var(--success)' : 'var(--text)';

        const verdict = document.getElementById('formTestVerdict');
        if (formTestEvents.length > 0) {
          verdict.style.background = 'rgba(6, 232, 159, 0.15)';
          verdict.innerHTML = `<strong style="color:var(--success);">Live Monitor Completato</strong><br><span style="font-size:13px;color:var(--text-light);">${formTestEvents.length} eventi catturati durante la sessione live</span>`;
        } else {
          verdict.style.background = 'rgba(255, 184, 77, 0.15)';
          verdict.innerHTML = '<strong style="color:var(--warning);">Nessun Evento</strong><br><span style="font-size:13px;color:var(--text-light);">Non sono stati aggiunti eventi dal Live Monitor</span>';
        }

        // Popola lista eventi
        const eventsList = document.getElementById('formTestEventsList');
        if (formTestEvents.length > 0) {
          eventsList.innerHTML = formTestEvents.map(e => `
            <li style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);">
              <span>
                <strong style="color:var(--primary);">${e.tracker || 'Unknown'}</strong>
                ${e.event ? `<span style="background:rgba(6,232,159,0.2);padding:2px 8px;border-radius:4px;margin-left:8px;font-size:12px;">${e.event}</span>` : ''}
              </span>
              <span style="font-size:12px;color:var(--text-light);">${e.eventCategory || 'custom'}</span>
            </li>
          `).join('');
        } else {
          eventsList.innerHTML = '<li style="color:var(--text-light);font-style:italic;padding:12px 0;">Nessun evento</li>';
        }
      }
      } // Fine else scanMode !== 'fast'

    }

    // Apri pagina test form
    function openFormTest() {
      const params = new URLSearchParams(window.location.search);
      const reportId = params.get('id');
      const url = reportData?.url;

      if (!url) return;

      const testUrl = `/form-test.html?url=${encodeURIComponent(url)}&reportId=${reportId}`;
      window.open(testUrl, 'formTest', 'width=1400,height=900');
    }

    function downloadJson() {
      if (!reportData) return;
      const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `audit-${reportData.url.replace(/[^a-z0-9]/gi, '_')}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function openLiveMonitor() {
      const params = new URLSearchParams(window.location.search);
      const reportId = params.get('id');
      const url = reportData?.url;

      if (!url) return;

      const monitorUrl = `/form-test.html?url=${encodeURIComponent(url)}&reportId=${reportId}`;
      window.open(monitorUrl, 'liveMonitor', 'width=1400,height=900');
    }

    // Mobile menu toggle
    const menuToggle = document.getElementById('menuToggle');
    const navLinks = document.getElementById('navLinks');

    menuToggle.addEventListener('click', () => {
      navLinks.classList.toggle('open');
    });

    // Listen for form-test updates via BroadcastChannel
    try {
      const channel = new BroadcastChannel('audit-report-update');
      channel.onmessage = (event) => {
        const params = new URLSearchParams(window.location.search);
        const currentReportId = params.get('id');
        if (event.data.type === 'form-test-updated' && event.data.reportId === currentReportId) {
          console.log('Form test aggiornato, ricarico report...');
          loadReport(); // Refresh report data
        }
      };
    } catch (e) {
      // Fallback: listen to localStorage changes
      window.addEventListener('storage', (event) => {
        if (event.key === 'audit-report-update') {
          try {
            const data = JSON.parse(event.newValue);
            const params = new URLSearchParams(window.location.search);
            const currentReportId = params.get('id');
            if (data.type === 'form-test-updated' && data.reportId === currentReportId) {
              console.log('Form test aggiornato, ricarico report...');
              loadReport();
            }
          } catch (e) {}
        }
      });
    }

    loadReport();
  </script>
</body>
</html>
